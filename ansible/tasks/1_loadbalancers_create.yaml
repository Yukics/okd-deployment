---
- name: Create loadbalancers VM
  community.general.proxmox_kvm:
    api_user: "{{ proxmox_api_user }}"
    api_password: "{{ proxmox_api_password }}"
    api_host: "{{ proxmox_api_host }}"
    api_port: "{{ proxmox_api_port }}"
    validate_certs: false
    node: "{{ item.node }}"
    vmid: "{{ item.template.id }}"
    clone: "{{ item.template.name }}"
    newid: "{{ item.id }}"
    name: "{{ item.name }}"
    full: true
    state: present
    timeout: 90
  loop: "{{ loadbalancers }}"

- name: Configure cloned VM
  community.general.proxmox_kvm:
    api_user: "{{ proxmox_api_user }}"
    api_password: "{{ proxmox_api_password }}"
    api_host: "{{ proxmox_api_host }}"
    api_port: "{{ proxmox_api_port }}"
    validate_certs: false
    node: "{{ item.node }}"
    vmid: "{{ item.id }}"
    name: "{{ item.name }}"
    tags:
      - okd
      - lb
    agent: enabled=1
    cores: "{{ item.cores }}"
    cpu: "host"
    memory: "{{ item.memory }}"
    storage: "{{ disk_storage }}"
    autostart: true
    onboot: true
    timeout: 90
    update: true
  loop: "{{ loadbalancers }}"

- name: Update cloned VM with new Cloud-init
  community.general.proxmox_kvm:
    api_user: "{{ proxmox_api_user }}"
    api_password: "{{ proxmox_api_password }}"
    api_host: "{{ proxmox_api_host }}"
    api_port: "{{ proxmox_api_port }}"
    validate_certs: false
    node: "{{ item.node }}"
    vmid: "{{ item.id }}"
    name: "{{ item.name }}"
    ciuser: "{{ item.user }}"
    cipassword: "{{ item.password }}"
    sshkeys: "{{ sshkeys }}"
    # boot: "order=scsi0;ide2"
    ipconfig:
      ipconfig0: "ip={{ item.ip }}/24,gw={{ gateway }}"
    nameservers: "{{ dns }}"
    searchdomains: "{{ searchdomain }}"
    timeout: 90
    update: true
  loop: "{{ loadbalancers }}"

- name: Start loadbalancers VM
  community.general.proxmox_kvm:
    api_user: "{{ proxmox_api_user }}"
    api_password: "{{ proxmox_api_password }}"
    api_host: "{{ proxmox_api_host }}"
    api_port: "{{ proxmox_api_port }}"
    node: "{{ item.node }}"
    name: "{{ item.name }}"
    timeout: 90
    state: started
  loop: "{{ loadbalancers }}"

- name: Add new hosts to pb execution
  add_host: 
    name: "{{ item.name }}.{{ domain }}" 
    ansible_ssh_host: "{{ item.ip }}" 
    groups: loadbalancers_hosts
    ansible_user: "{{ item.user }}"
  loop: "{{ loadbalancers }}"

- name: Pause for 2 minutes, wait VM to start
  ansible.builtin.pause:
    minutes: 2

- name: Remove cloud-init drive
  community.general.proxmox_disk:
    api_user: "{{ proxmox_api_user }}"
    api_password: "{{ proxmox_api_password }}"
    api_host: "{{ proxmox_api_host }}"
    api_port: "{{ proxmox_api_port }}"
    validate_certs: false
    vmid: '{{item.id}}'
    disk: 'ide2'
    state: absent
  loop: '{{ loadbalancers }}'